apiVersion: batch/v1
kind: CronJob
metadata:
  name: '{{ include "sas-linux.name" . }}-cron-etl'
spec:
  schedule: '{{ .Values.etl.schedule }}'
  jobTemplate:
    spec:
      template:
        spec:
          # security-context:
          #   runAsUser: 1000
          #   runAsGroup: 1001
          containers:
          - name: '{{ include "sas-linux.name" . }}-cron-etl'
            image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
            imagePullPolicy: IfNotPresent
            env:
            {{- range $key, $value := .Values.env }}
            - name: {{ $key }}
              value: "{{ $value }}"
            {{- end }}
            command:
            - /bin/bash
            - -c 
            - su SAS; cd;
              export PATH="$PATH:/opt/mssql-tools18/bin";              
              date;
              echo 'Running PHCMartETL.sh';
              $WILDFLY_HOME/wildfly-10.0.0.Final/nedssdomain/Nedss/BatchFiles/PHCMartETL.sh;
              ls -ltr $WILDFLY_HOME/wildfly-10.0.0.Final/nedssdomain/Nedss/report/log;
              echo '---- START PHCMartETL.log ERRORS ----';
              cat PHCMartETL.log | grep -i "error";
              echo '---- END PHCMartETL.log ERRORS ----';            
              date;
              echo 'Running MasterEtl.sh';
              $WILDFLY_HOME/wildfly-10.0.0.Final/nedssdomain/Nedss/BatchFiles/MasterEtl.sh;
              ls -ltr $WILDFLY_HOME/wildfly-10.0.0.Final/nedssdomain/Nedss/report/log;
              echo '---- START MasterETL1.lst ERRORS ----';
              cat MasterETL1.lst | grep -i "error";
              echo '---- END MasterETL1.lst ERRORS ----';
              echo '---- START Drop_Create_Tables.log ERRORS ----';
              cat Drop_Create_Tables.log | grep -i "error";
              echo '---- END Drop_Create_Tables.log ERRORS ----';
              echo '---- START MasterETL1.log ERRORS ----'; 
              cat MasterETL1.log | grep -i "error";
              echo '---- END MasterETL1.log ERRORS ----';
              echo '---- START MasterEtl2.log ERRORS ----'; 
              cat MasterEtl2.log | grep -i "error";
              echo '---- END MasterEtl2.log ERRORS ----';
              echo '---- START SSIS.log ERRORS ----'; 
              cat SSIS.log | grep -i "error";
              echo '---- END SSIS.log ERRORS ----';
              echo '---- START DynamicDatamart.log ERRORS ----';
              cat DynamicDatamart.log | grep -i "error";
              echo '---- END DynamicDatamart.log ERRORS ----';  
          restartPolicy: Never