name: Helm Lint

on:
  pull_request:
    branches:
      - main
    paths:
      - "charts/**"
      - "argocd/**"
  workflow_dispatch:

jobs:
  helm-lint:
    name: Lint Helm Charts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Lint all Helm charts
        run: |
          set -e

          echo "Starting Helm lint for all charts"
          echo ""

          failed_charts=()
          passed_charts=()

          # Find all directories with Chart.yaml
          for chart_dir in charts/*/; do
            chart_name=$(basename "$chart_dir")

            # Check if Chart.yaml exists
            if [ ! -f "${chart_dir}Chart.yaml" ]; then
              continue
            fi

            # Run helm lint
            echo "========================================"
            echo "Linting: $chart_name"
            echo "========================================"
            if helm lint "$chart_dir"; then
              passed_charts+=("$chart_name")
            else
              failed_charts+=("$chart_name")
            fi
            echo ""
          done

          # Print summary
          echo "========================================"
          echo "Lint Summary"
          echo "========================================"
          echo "Passed: ${#passed_charts[@]}"
          echo "Failed: ${#failed_charts[@]}"
          echo ""

          if [ ${#failed_charts[@]} -gt 0 ]; then
            echo "Failed charts:"
            printf '  - %s\n' "${failed_charts[@]}"
            echo ""
            echo "::error::Helm lint failed for ${#failed_charts[@]} chart(s)"
            exit 1
          fi

          echo "All charts passed helm lint"

      - name: Lint ArgoCD chart
        run: |
          echo "========================================"
          echo "Linting: ArgoCD"
          echo "========================================"
          if [ -f "argocd/Chart.yaml" ]; then
            helm lint argocd/
          else
            echo "No ArgoCD Chart.yaml found, skipping"
          fi
